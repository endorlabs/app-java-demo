name: "Endor Labs Vulnerability Scan"

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

jobs:
  endor-scan:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    environment: copilot
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'microsoft'
          java-version: '17'
      
      - name: Setup endorctl
        run: |
          curl https://api.staging.endorlabs.com/download/endorlabs/v1.7.688/binaries/endorctl_v1.7.688_linux_amd64 -o endorctl
          echo "2dd5e32c21afc893d1229a1c6e9864ad82ce2d1bc2f8e6cbfe9f5acba7f461a9 endorctl" | sha256sum --check
          chmod +x ./endorctl
      
      - name: Run Endor Labs Vulnerability Scan
        env:
          ENDOR_API_KEY: ${{ secrets.ENDOR_API_KEY }}
          ENDOR_API_SECRET: ${{ secrets.ENDOR_API_SECRET }}
          ENDOR_NAMESPACE: ${{ secrets.ENDOR_NAMESPACE }}
        run: |
          ./endorctl scan \
            --path=. \
            --dependencies \
            --secrets \
            --languages=java \
            --output-type=summary \
            --namespace=${{ secrets.ENDOR_NAMESPACE }} \
            --api-key=${{ secrets.ENDOR_API_KEY }} \
            --api-secret=${{ secrets.ENDOR_API_SECRET }}
      
      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: endor-scan-results
          path: |
            *.sarif
            endor-scan-*.json
          retention-days: 30
