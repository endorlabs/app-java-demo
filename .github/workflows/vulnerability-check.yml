name: Maven Dependency Vulnerability Check

on:
  push:
    paths:
      - 'pom.xml'
  pull_request:
    paths:
      - 'pom.xml'
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest
    name: Scan Maven Dependencies for Vulnerabilities
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Parse Maven dependencies
        run: |
          echo "Parsing dependencies from pom.xml..."
          python3 parse-dependencies.py
      
      - name: Generate vulnerability reports
        run: |
          echo "Generating vulnerability reports..."
          ./check-vulnerabilities.sh
          python3 comprehensive-vuln-check.py
      
      - name: Display summary
        run: |
          echo "========================================="
          echo "Vulnerability Scan Summary"
          echo "========================================="
          cat comprehensive-vulnerability-report.md | grep -A 5 "Executive Summary"
      
      - name: Upload vulnerability reports
        uses: actions/upload-artifact@v3
        with:
          name: vulnerability-reports
          path: |
            comprehensive-vulnerability-report.md
            vulnerability-check-report.md
            dependency-list.md
            dependencies-to-check.json
          retention-days: 90
      
      - name: Check for critical vulnerabilities
        run: |
          if grep -q "ðŸ”´ Critical" comprehensive-vulnerability-report.md; then
            echo "::error::Critical vulnerabilities detected! Please review the vulnerability report."
            exit 1
          fi
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('comprehensive-vulnerability-report.md', 'utf8');
            
            // Extract summary section
            const summaryMatch = report.match(/## Executive Summary[\s\S]*?(?=##)/);
            const summary = summaryMatch ? summaryMatch[0] : 'See full report in artifacts';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Vulnerability Scan Results\n\n${summary}\n\nðŸ“„ Full reports available in workflow artifacts.`
            });
