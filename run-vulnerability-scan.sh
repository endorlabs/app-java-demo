#!/bin/bash

# Endor Labs Vulnerability Scan Script
# This script runs a comprehensive security scan using Endor Labs

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "================================================"
echo "  Endor Labs Vulnerability Scan"
echo "================================================"
echo ""

# Check if endorctl is installed
if ! command -v endorctl &> /dev/null; then
    echo -e "${RED}ERROR: endorctl is not installed${NC}"
    echo "Please install endorctl from https://docs.endorlabs.com"
    exit 1
fi

# Check for required environment variables
if [ -z "$ENDOR_API_KEY" ]; then
    echo -e "${RED}ERROR: ENDOR_API_KEY environment variable is not set${NC}"
    echo "Please set your Endor Labs API key:"
    echo "  export ENDOR_API_KEY=\"your-api-key\""
    exit 1
fi

if [ -z "$ENDOR_API_SECRET" ]; then
    echo -e "${RED}ERROR: ENDOR_API_SECRET environment variable is not set${NC}"
    echo "Please set your Endor Labs API secret:"
    echo "  export ENDOR_API_SECRET=\"your-api-secret\""
    exit 1
fi

if [ -z "$ENDOR_NAMESPACE" ]; then
    echo -e "${YELLOW}WARNING: ENDOR_NAMESPACE not set, using default 'yolo'${NC}"
    export ENDOR_NAMESPACE="yolo"
fi

echo "Configuration:"
echo "  Namespace: $ENDOR_NAMESPACE"
echo "  API Endpoint: ${ENDOR_API:-https://api.endorlabs.com}"
echo ""

# Get the repository root directory
REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
echo "Scanning repository: $REPO_DIR"
echo ""

# Build the project first
echo -e "${GREEN}Step 1: Building the project...${NC}"
if [ -f "pom.xml" ]; then
    mvn clean install -DskipTests
    echo -e "${GREEN}✓ Build completed${NC}"
else
    echo -e "${YELLOW}⚠ No pom.xml found, skipping build${NC}"
fi
echo ""

# Run the Endor Labs scan
echo -e "${GREEN}Step 2: Running Endor Labs scan...${NC}"
echo "This may take several minutes..."
echo ""

# Run scan with all security checks
endorctl scan \
    --path="$REPO_DIR" \
    --namespace="$ENDOR_NAMESPACE" \
    --verbose \
    || {
        echo -e "${RED}✗ Scan failed${NC}"
        echo "Check the error messages above for details"
        exit 1
    }

echo ""
echo -e "${GREEN}✓ Scan completed successfully${NC}"
echo ""
echo "================================================"
echo "  Next Steps"
echo "================================================"
echo "1. Review the scan results above"
echo "2. Visit your Endor Labs dashboard for detailed analysis"
echo "3. Address any critical vulnerabilities found"
echo "4. Update dependencies as recommended"
echo ""
